"use strict";!function(t,e){"function"==typeof define&&define.amd?define(["leaflet"],t):"object"==typeof exports&&(module.exports=t(require("leaflet"))),void 0!==e&&e.L&&(e.L.YourPlugin=t(L))}(function(l){return l.speechBubble=function(t,e){return t?new l.SpeechBubble(t,e):new l.SpeechBubble(null,e)},l.SpeechBubble=l.DivOverlay.extend({includes:l.Mixin.Events,options:{width:null,height:null,top:null,left:null,strenth:null,base:null,angle:0,background:"#FFF",borderThick:2,borderColor:"#000",borderRadius:10},_toLatLng:function(t,e,i){return t instanceof l.LatLng?t:l.Util.isArray(t)&&"object"!=typeof t[0]?3===t.length?new l.LatLng(t[0],t[1],t[2]):2===t.length?new l.LatLng(t[0],t[1]):null:null==t?t:"object"==typeof t&&"lat"in t?new l.LatLng(t.lat,"lng"in t?t.lng:t.lon,t.alt):"object"==typeof t&&"getLatLng"in t?t.getLatLng():void 0===e?null:new l.LatLng(t,e,i)},initialize:function(t,e){t&&l.setOptions(this,t),this._source=e,this.turn=0,this._div=l.DomUtil.create("div","leaflet-speechbubble",this._container),this._curs=l.DomUtil.create("div","leaflet-speechbubble-curs",this._div),this._anchor=l.DomUtil.create("div","leaflet-speechbubble-anchor",this._container),this._arrow=l.DomUtil.create("div","leaflet-speechbubble-arrow",this._curs),this._arrow_back=l.DomUtil.create("div","leaflet-speechbubble-arrow-back",this._arrow),this._divcontent=l.DomUtil.create("div","leaflet-speechbubble-content",this._div),this._latlng=this._toLatLng(e),this.options.class&&this.setClassName(this.options.class)},className:"leaflet-speechbubble",setClassName:function(t){t&&"string"==typeof t&&(this.className=t,this._div.className=this.className)},addClass:function(t){t&&"string"==typeof t&&this._div.classList.add(t)},removeClass:function(t){t&&"string"==typeof t&&this._div.classList.contains(t)&&this._div.classList.remove(t)},_setDefaultDim:function(){var t=this._container.clientWidth/2,e=this._container.clientHeight/2;if(this.options.height||(this.options.height=2*this._container.clientHeight/4),this.options.width||(this.options.width=2*this._container.clientWidth/4),!this.options.strenth){var i=this._container.clientHeight-this.options.height,s=this._container.clientWidth-this.options.width;this.options.strenth=Math.min(s,i)/2,this.options.base=this.options.strenth/20*3}this.options.top||(this.options.top=e-this.options.height/2),this.options.left||(this.options.left=t-this.options.width/2)},_update_autoplacement:function(){var t=this._map.getCenter(),e=this._latlng.lng-t.lng,i=this._latlng.lat-t.lat;this.options.angle=180*Math.atan2(i,e)/Math.PI;var s=this._deg2rad(this.options.angle%360),n=this._getLineLengthInRect(this.options.angle,this._container.clientWidth,this._container.clientHeight),o=Math.cos(-s)*n+this._container.clientWidth/2,h=Math.sin(-s)*n+this._container.clientHeight/2,a=o-Math.cos(s)*(this.options.strenth/2),r=h+Math.sin(s)*(this.options.strenth/2),l=this._getLineLengthInRect(this.options.angle,this.options.width,this.options.height);this._anchor_center={x:a-Math.cos(s)*l,y:r+Math.sin(s)*l},this.options.top=this._anchor_center.y-this.options.height/2,this.options.left=this._anchor_center.x-this.options.width/2,this._div.style.top=this.options.top+"px",this._div.style.left=this.options.left+"px"},_update_cursor:function(){var t=this._map.getCenter();if(this._anchor_center){var e=l.point(this._anchor_center.x,this._anchor_center.y);t=this._map.containerPointToLatLng(e)}var i=this._latlng.lng-t.lng,s=this._latlng.lat-t.lat;this.options.angle=180*Math.atan2(s,i)/Math.PI;var n=this._getLineLengthInRect(this.options.angle,this.options.width,this.options.height),o=this._deg2rad(this.options.angle%360),h=Math.cos(-o)*n+this.options.width/2,a=Math.sin(-o)*n+this.options.height/2,r=l.point(h+this.options.left,a+this.options.top);this._offsetCenter=this._map.containerPointToLatLng(r),this._curs.style.position="absolute",this._curs.style.top=a+"px",this._curs.style.left=h+"px"},_update_arrow:function(){var t=this._latlng.lng-this._offsetCenter.lng,e=this._latlng.lat-this._offsetCenter.lat;this.options.angle=180*Math.atan2(e,t)/Math.PI,180<this.options.angle%360-this.options.lastAngle&&this.turn--,180<this.options.lastAngle-this.options.angle%360&&this.turn++,this.options.lastAngle=this.options.angle,this.options.angle=360*this.turn+this.options.angle,this._curs.style.transform="rotate("+-1*this.options.angle+"deg) "},update:function(){if(this._map&&(this._setDefaultDim(),this._divcontent.innerHTML=this._content,this._update_autoplacement(),this._update_cursor(),this._update_arrow(),!this._firstUpdate)){this._div.style.height=this.options.height+"px",this._div.style.background=this.options.borderColor,this._div.style.width=this.options.width+"px",this._div.style.zIndex=1e4,this._div.style.borderRadius=this.options.borderRadius+"px",this._div.style.position="absolute",this._arrow.style.position="absolute",this._arrow.style.border=this.options.base+"px solid transparent",this._arrow.style.borderRight="none",this._arrow.style.borderLeft=this.options.strenth+"px solid "+this.options.borderColor,this._arrow.style.transform="translate(-"+3*this.options.base+"px,-50%)",this._arrow.style.borderBottomLeftRadius=this.options.base+"px",this._arrow.style.borderTopLeftRadius=this.options.base+"px",this._arrow_back.style.position="absolute",this._arrow_back.style.border=this.options.base+"px solid transparent",this._arrow_back.style.borderRight="none",this._arrow_back.style.borderLeft=this.options.strenth+"px solid "+this.options.background;var t=5*this.options.borderThick;this._arrow_back.style.transform="translate("+(-this.options.strenth-t)+"px,-"+this.options.base+"px)",this._arrow_back.style.borderBottomLeftRadius=this.options.base+"px",this._arrow_back.style.borderTopLeftRadius=this.options.base+"px",this._divcontent.style.position="absolute",this._divcontent.style.top=this.options.borderThick+"px",this._divcontent.style.left=this.options.borderThick+"px",this._divcontent.style.right=this.options.borderThick+"px",this._divcontent.style.bottom=this.options.borderThick+"px",this._divcontent.style.background=this.options.background,this._divcontent.style.borderRadius=this.options.borderRadius-this.options.borderThick+"px",this._firstUpdate=!0}},remove:function(t){return this.onRemove(this._map,t),this},onAdd:function(t){this._map=t,this._container=t.getContainer(),t.getContainer().appendChild(this._div),(t._speechbubble=this)._speechbubble&&(this._speechbubble.update,1)&&t.on("move ",this._speechbubble.update),"function"==typeof t._speechbubble.update&&t._speechbubble.update()},addTo:function(t){return this.onAdd(t),this},onRemove:function(t,e){this.timer&&clearInterval(this.timer),t.getContainer().removeChild(this._div),this._map=null},_animateZoom:function(t){},_adjustPan:function(t){},getEvents:function(){return{}},_setStrenth:function(t){this.options.strenth=t,this.update()},_setAngle:function(t){this.options.deg=t,this.update()},_deg2rad:function(t){return 2*t*Math.PI/360},_rad2deg:function(t){return 180*t/Math.PI},_getLineLengthInRect:function(t,e,i){t%=360;var s=Math.abs(this._deg2rad(t)),n=e/2,o=i/2,h=Math.atan(o/n);if(h<=s&&s<=Math.PI-h||s>=Math.PI+h&&s<=2*Math.PI-h)e=Math.abs(o/Math.sin(s));else e=Math.abs(n/Math.cos(s));return e}}),l.Layer.include({bindSpeechBubble:function(t,e){return t instanceof l.SpeechBubble?(setOptions(t,e),(this._speechbubble=t)._source=this):(this._speechbubble&&!e||(this._speechbubble=new l.SpeechBubble(e,this)),this._speechbubble.setContent(t)),this},speechBubbleMove:function(t){if(void 0!==t.pinch&&!0===t.pinch)return t;this._speechbubble&&(this._speechbubble._map.getBounds().contains(this._speechbubble.getLatLng())?this._speechbubble._map.closeSpeechBubble():this._speechbubble.update())},unbindSpeechBubble:function(){return this._speechbubble&&(this.off({move:this._speechbubble.update}),this._speechbubbleHandlersAdded=!1,this._speechbubble=null),this},openSpeechBubble:function(t,e){if(t instanceof l.Layer||(e=t,t=this),t instanceof l.FeatureGroup)for(var i in this._layers){t=this._layers[i];break}return e||(e=t.getCenter?t.getCenter():t.getLatLng()),this._speechbubble&&this._map&&(this._speechbubble._source=t,this._speechbubble.update(),this._map.openSpeechBubble(this._speechbubble,e),this._speechbubbleHandlersAdded||(this._map.on({zoom:this.speechBubbleMove,move:this.speechBubbleMove}),this._speechbubbleHandlersAdded=!0)),this}}),l.Map.include({openSpeechBubble:function(t,e,i){return void 0!==this._speechbubble&&this._speechbubble&&this.closeSpeechBubble(this._speechbubble),t instanceof l.SpeechBubble||(t=new l.SpeechBubble(i).setContent(t)),e&&t.setLatLng(e),this.hasLayer(t)?this:(this._speechbubble=t,this._speechbubble.update(),this.addLayer(t))},closeSpeechBubble:function(t){return t&&t!==this._speechbubble||(t=this._speechbubble,this._speechbubble=null),t&&this.removeLayer(t),this}}),l.SpeechBubble},window);