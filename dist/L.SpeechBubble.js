"use strict";!function(t,e){"function"==typeof define&&define.amd?define(["leaflet"],t):"object"==typeof exports&&(module.exports=t(require("leaflet"))),void 0!==e&&e.L&&(e.L.YourPlugin=t(L))}(function(t){return t.speechBubble=function(e,i){return e?new t.SpeechBubble(e,i):new t.SpeechBubble(null,i)},t.SpeechBubble=t.DivOverlay.extend({includes:t.Mixin.Events,options:{width:null,height:null,top:null,left:null,strenth:200,base:30,angle:0,background:"#FFF",borderThick:2,borderColor:"#000",borderRadius:10},_toLatLng:function(e,i,s){return e instanceof t.LatLng?e:t.Util.isArray(e)&&"object"!=typeof e[0]?3===e.length?new t.LatLng(e[0],e[1],e[2]):2===e.length?new t.LatLng(e[0],e[1]):null:void 0===e||null===e?e:"object"==typeof e&&"lat"in e?new t.LatLng(e.lat,"lng"in e?e.lng:e.lon,e.alt):"object"==typeof e&&"getLatLng"in e?e.getLatLng():void 0===i?null:new t.LatLng(e,i,s)},initialize:function(e,i){e&&t.setOptions(this,e),this._source=i,this.turn=0,this._div=t.DomUtil.create("div","leaflet-speechbubble",this._container),this._curs=t.DomUtil.create("div","leaflet-speechbubble-curs",this._div),this._arrow=t.DomUtil.create("div","leaflet-speechbubble-arrow",this._curs),this._arrow_back=t.DomUtil.create("div","leaflet-speechbubble-arrow-back",this._arrow),this._divcontent=t.DomUtil.create("div","leaflet-speechbubble-content",this._div),this._latlng=this._toLatLng(i)},className:"leaflet-speechbubble",setClassName:function(t){t&&"string"==typeof t&&(this.className=t,this._div.className=this.className)},addClass:function(t){t&&"string"==typeof t&&this._div.classList.add(t)},removeClass:function(t){t&&"string"==typeof t&&this._div.classList.contains(t)&&this._div.classList.remove(t)},_setDefaultDim:function(){var t=this._container.clientWidth/2,e=this._container.clientHeight/2;this.options.height||(this.options.height=2*this._container.clientHeight/4),this.options.width||(this.options.width=2*this._container.clientWidth/4),this.options.top||(this.options.top=e-this.options.height/2),this.options.left||(this.options.left=t-this.options.width/2)},update:function(){if(this._map){console.log("update"),this._setDefaultDim();var e=this._map.getCenter(),i=this._latlng.lng-e.lng,s=this._latlng.lat-e.lat;this.options.angle=180*Math.atan2(s,i)/Math.PI,console.log(this.options.angle),this._divcontent.innerHTML=this._content;var o=this._getLineLengthInRect(this.options.angle,this.options.width,this.options.height),n=this._deg2rad(this.options.angle%360);this._div.style.height=this.options.height+"px",this._div.style.background=this.options.borderColor,this._div.style.width=this.options.width+"px",this._div.style.top=this.options.top+"px",this._div.style.zIndex=1e4,this._div.style.left=this.options.left+"px",this._div.style.borderRadius=this.options.borderRadius+"px",this._div.style.position="absolute";var h=Math.cos(-n)*o+this.options.width/2,a=Math.sin(-n)*o+this.options.height/2,r=t.point(h+this.options.left,a+this.options.top);this._offsetCenter=this._map.containerPointToLatLng(r);var i=this._latlng.lng-this._offsetCenter.lng,s=this._latlng.lat-this._offsetCenter.lat;this.options.angle=180*Math.atan2(s,i)/Math.PI,this.options.angle%360-this.options.lastAngle>180&&this.turn--,this.options.lastAngle-this.options.angle%360>180&&this.turn++,this.options.lastAngle=this.options.angle,this.options.angle=360*this.turn+this.options.angle,this._curs.style.position="absolute",this._curs.style.top=a+"px",this._curs.style.left=h+"px",this._curs.style.transform="rotate("+-1*this.options.angle+"deg) ",this._arrow.style.position="absolute",this._arrow.style.border=this.options.base+"px solid transparent",this._arrow.style.borderRight="none",this._arrow.style.borderLeft=this.options.strenth+"px solid "+this.options.borderColor,this._arrow.style.transform="translate(-"+this.options.base+"px,-50%)",this._arrow.style.borderBottomLeftRadius=this.options.base+"px",this._arrow.style.borderTopLeftRadius=this.options.base+"px",this._arrow_back.style.position="absolute",this._arrow_back.style.border=this.options.base+"px solid transparent",this._arrow_back.style.borderRight="none",this._arrow_back.style.borderLeft=this.options.strenth+"px solid "+this.options.background;var l=5*this.options.borderThick;this._arrow_back.style.transform="translate("+(-this.options.strenth-l)+"px,-"+this.options.base+"px)",this._arrow_back.style.borderBottomLeftRadius=this.options.base+"px",this._arrow_back.style.borderTopLeftRadius=this.options.base+"px",this._divcontent.style.position="absolute",this._divcontent.style.top=this.options.borderThick+"px",this._divcontent.style.left=this.options.borderThick+"px",this._divcontent.style.right=this.options.borderThick+"px",this._divcontent.style.bottom=this.options.borderThick+"px",this._divcontent.style.background=this.options.background,this._divcontent.style.borderRadius=this.options.borderRadius-this.options.borderThick+"px"}},remove:function(t){return this.onRemove(this._map,t),this},onAdd:function(t){this._map=t,this._container=t.getContainer(),t.getContainer().appendChild(this._div),t._speechbubble=this,t.on("move ",function(){this._speechbubble.update()}),t.on("zoom ",function(){this._speechbubble.update()}),t._speechbubble.update()},addTo:function(t){return this.onAdd(t),this},onRemove:function(t,e){this.timer&&clearInterval(this.timer),t.getContainer().removeChild(this._div),this._map=null},_setStrenth:function(t){this.options.strenth=t,this.update()},_setAngle:function(t){this.options.deg=t,this.update()},_deg2rad:function(t){return 2*t*Math.PI/360},_rad2deg:function(t){return 180*t/Math.PI},_getLineLengthInRect:function(t,e,i){t%=360;var s=Math.abs(this._deg2rad(t)),o=e/2,n=i/2,h=Math.atan(n/o);if(s>=h&&s<=Math.PI-h||s>=Math.PI+h&&s<=2*Math.PI-h)e=Math.abs(n/Math.sin(s));else var e=Math.abs(o/Math.cos(s));return e}}),t.Layer.include({bindSpeechBubble:function(e,i){return e instanceof t.SpeechBubble?(setOptions(e,i),this._speechbubble=e,e._source=this):(this._speechbubble&&!i||(this._speechbubble=new t.SpeechBubble(i,this)),this._speechbubble.setContent(e)),this},openSpeechBubble:function(e,i){if(e instanceof t.Layer||(i=e,e=this),e instanceof t.FeatureGroup)for(var s in this._layers){e=this._layers[s];break}return i||(i=e.getCenter?e.getCenter():e.getLatLng()),this._speechbubble&&this._map&&(this._speechbubble._source=e,this._speechbubble.update(),this._map.openSpeechBubble(this._speechbubble,i)),this}}),t.Map.include({openSpeechBubble:function(e,i,s){return e instanceof t.SpeechBubble||(e=new t.SpeechBubble(s).setContent(e)),i&&e.setLatLng(i),this.hasLayer(e)?this:(this._speechbubble=e,this._speechbubble.update(),this.addLayer(e))},closeSpeechBubble:function(t){return t&&t!==this._speechbubble||(t=this._speechbubble,this._speechbubble=null),t&&this.removeLayer(t),this}}),t.SpeechBubble},window);